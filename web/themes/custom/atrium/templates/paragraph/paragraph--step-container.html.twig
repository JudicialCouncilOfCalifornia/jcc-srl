{#
/**
 * @file
 * Template for "Step Container" Paragraph.
 */
#}
{% extends 'paragraph.html.twig' %}
{% block content %}

  {% if content.field_steps|render %}

    {#
    /**
    * Step Display
    * field_step_display (list)
    *
    * There are currently two display options. These dictate what component is
    * used to render steps.
    *
    * 1. Vertical Steps (vertical_steps): Known as "Steps" in Pattern Lab.
    * 2. Flowmap (flowmap): Known as "Timeline" in Pattern Lab.
    */
    #}
    {% set component = paragraph.field_step_display.value %}

    {% set headergroup = {
      brow: (component == 'vertical_steps') ? 'Next steps'|t : null,
      title: content.field_title_display,
      lead: content.field_description,
    } %}

    {% set step_content = [] %}
    {% set steps = paragraph.field_steps %}

    {% for key, item in steps.value %}
      {% set read_more = [] %}
      {# â‡£ This check is important because Step fields are NOT required. Empty
      Steps are possible, and would return the wrong data. #}
      {% if steps.get(key).entity.field_title_display.value %}
        {% set step = steps.get(key).entity %}

        {# Prepare "Read more" toggle #}
        {% if step.field_details.value %}
          {% set read_more = {
            id: 'read-more-' ~ step.id(),
            title: step.field_details_link_text.value|default('Read more'|t),
            content: step.field_details|view,
          } %}
        {% endif %}

        {# Store each step in an array for the Pattern component. #}
        {% set step_content = step_content|merge([{
          title: step.field_title_display|view,
          excerpt: step.field_description|view,
          read_more: read_more
        }]) %}
      {% endif %}
    {% endfor %}

    {% if component == 'flowmap' %}
      {% include '@organisms/sections/timeline/timeline.twig' with {
        headergroup: headergroup,
        timeline: step_content,
        background_variant: 'has-background-color--dark'
      } only %}

    {% elseif component == 'vertical_steps' %}
      {% include '@organisms/sections/steps/steps.twig' with {
        headergroup: headergroup,
        steps: step_content,
      } only %}

    {% endif %}
  {% endif %}

  {{ content|without(
    'field_create_anchor',
    'field_description',
    'field_step_display',
    'field_steps',
    'field_title_display'
  ) }}
{% endblock %}
