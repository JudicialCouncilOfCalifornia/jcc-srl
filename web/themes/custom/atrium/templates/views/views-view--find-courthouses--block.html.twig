{#
/**
 * @file
 * Template for "Find the Right Court" view.
 *
 * This View returns a single result, based on `field_parent` set in the entity
 * currently being Viewed. Typically, the level of information we're getting at
 * here would be a few levels deep, e.g. views_view_fields. However, the Pattern
 * Lab component requires all data te be passed in one place, so we are using
 * the Node entity from the views result to get data we need.
 */
#}

{% extends 'views-view.html.twig' %}

{# {% block header %} #}
  {# {% set court_search %}
    {{ drupal_view('find_courts', 'block') }}
  {% endset %}
  {% include '@molecules/blocks/hero/hero.twig' with {
    hero: {
      background_variant: 'has-background-color--light--secondary',
      column_variant: 'has-one-column',
      title: drupal_title(),
      lead: header,
      column_content_right: court_search,
    }
  } %} #}
{# {% endblock %} #}

{# {% block exposed %} #}
  {# "Unset" this block since exposed is used in the header block #}
{# {% endblock %} #}


{% block content %}
  {% set items = [] %}
  {% set courthouses = rows.0['#rows'].0['#view'].result %}
  {% set court = rows.0['#rows'].0['#view'].result.0._relationship_entities.field_court %}

  {% for row in courthouses %}
    {% set entity = row._entity %}

    {# address needs to be rendered at the same time the nl2br filter is used
       or the <br> will be escaped #}
    {% set address %}
      {{ entity.field_address.value|nl2br }}
    {% endset %}

    {# field_matters_served is a basic text field with values separated by commas #}
    {% set tags = [] %}
    {% for tag in entity.field_matters_served.value|split(',') %}
      {% set tags = tags|merge([{
        text: tag|trim
      }]) %}
    {% endfor %}

    {# Building hours #}
    {% if entity.field_building_hours_summary.value %}
      {% set building_hours = entity.field_building_hours_summary.value %}
    {% else %}
      {% set building_hours = [
        entity.field_building_hours_monday.value ? 'M'|t ~ ': ' ~  entity.field_building_hours_monday.value,
        entity.field_building_hours_tuesday.value ? 'Tu'|t ~ ': ' ~  entity.field_building_hours_tuesday.value,
        entity.field_building_hours_wednesday.value ? 'W'|t ~ ': ' ~  entity.field_building_hours_wednesday.value,
        entity.field_building_hours_thursday.value ? 'Thu'|t ~ ': ' ~  entity.field_building_hours_thursday.value,
        entity.field_building_hours_friday.value ? 'F'|t ~ ': ' ~  entity.field_building_hours_friday.value,
      ]|trim_empty|join('<br>') %}
    {% endif %}

    {# Filing hours #}
    {% if entity.field_filing_hours_summary.value %}
      {% set filing_hours = entity.field_filing_hours_summary.value %}
    {% else %}
      {% set filing_hours = [
        entity.field_filing_hours_monday.value ? 'M'|t ~ ': ' ~  entity.field_filing_hours_monday.value,
        entity.field_filing_hours_tuesday.value ? 'Tu'|t ~ ': ' ~  entity.field_filing_hours_tuesday.value,
        entity.field_filing_hours_wednesday.value ? 'W'|t ~ ': ' ~  entity.field_filing_hours_wednesday.value,
        entity.field_filing_hours_thursday.value ? 'Thu'|t ~ ': ' ~  entity.field_filing_hours_thursday.value,
        entity.field_filing_hours_friday.value ? 'F'|t ~ ': ' ~  entity.field_filing_hours_friday.value,
      ]|trim_empty|join('<br>') %}
    {% endif %}

    {# Self help hours #}
    {% set selfhelp_hours %}
      {% if entity.field_selfhelp_hours_summary.value %}
        {{ entity.field_selfhelp_hours_summary.value }}
      {% else %}
        {% for item in [
          entity.field_selfhelp_hours_monday.value ? 'M'|t ~ ': ' ~ entity.field_selfhelp_hours_monday.value,
          entity.field_selfhelp_hours_tuesday.value ? 'Tu'|t ~ ': ' ~ entity.field_selfhelp_hours_tuesday.value,
          entity.field_selfhelp_hours_wednesday.value ? 'W'|t ~ ': ' ~ entity.field_selfhelp_hours_wednesday.value,
          entity.field_selfhelp_hours_thursday.value ? 'Thu'|t ~ ': ' ~ entity.field_selfhelp_hours_thursday.value,
          entity.field_selfhelp_hours_friday.value ? 'F'|t ~ ': ' ~ entity.field_selfhelp_hours_friday.value,
        ]|trim_empty %}
          {{ item }}<br>
        {% endfor %}
      {% endif %}
    {% endset %}

    {% set location = {
      brow: entity.field_court.0.entity.title.value ~ ' County'|t,
      title: entity.title.value,
      address: address,
      phone: {
        title: entity.field_phone.0.value,
        url: 'tel:' ~ entity.field_phone.0.value|replace({'(': '', ')': '', ' ': '-'})|url_encode,
      },
      website: {
        title: entity.title.value ~ ' ' ~ 'Website'|t,
        url: entity.field_link.0.url,
      },
      tags_label: 'Matters Served'|t,
      tags: tags,
      directions_title: 'Get Directions'|t,
      map: {
        src: file_url(entity.field_image.0.entity.field_media_image.entity.uri.value),
      },
      hours_label: 'Hours'|t,
      hours: [
        building_hours ? {
          label: 'Building'|t,
          details: building_hours,
        },
        filing_hours ? {
          label: 'Clerks'|t,
          details: filing_hours,
        },
        selfhelp_hours ? {
          label: 'Self Help'|t,
          details: selfhelp_hours,
        },
      ]|trim_empty
    } %}

    {% set items = items|merge([location]) %}
  {% endfor %}
<pre>
  {{ dump(court.field_description.0|keys) }}
</pre>
  {% include '@molecules/blocks/court-summary/court-summary.twig' with {
    court_summary: {
      quantity: 'There are %q% Courthouse Locations.'|replace({'%q%': courthouses|length}),
      body: court.field_description.0.value|check_markup(court.field_description.0.format)
    }
  } %}

  {% include '@organisms/sections/locations/locations.twig' with {
    locations: {
      items: items
    }
  } %}
{% endblock %}
